import 'package:flutter/material.dart';
import 'package:cached_network_image/cached_network_image.dart';

import '../../../../../common/constants.dart' as K;
import '../../../routes/flux_navigate.dart';

import 'package:graphql/client.dart' show gql, QueryOptions, FetchPolicy;

import '../../../../../frameworks/shopify/services/advanced_options_service.dart';
import '../../../../../frameworks/shopify/services/shopify_service.dart' show ShopifyService;
import '../../../../../services/services.dart';

// Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù„ØªÙ…Ø±ÙŠØ±Ù‡ Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
import '../../../../../models/entities/product.dart';

class AdvancedOptionsStrip extends StatefulWidget {
  final dynamic product; // Product Ø£Ùˆ Ø£ÙŠ ÙƒØ§Ø¦Ù† ÙÙŠÙ‡ id Ùˆ name
  final String defaultLabel;
  final double cardWidth;
  final double cardImageSize;

  const AdvancedOptionsStrip({
    Key? key,
    required this.product,
    this.defaultLabel = 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ø®Ø±Ù‰',
    this.cardWidth = 136,
    this.cardImageSize = 120,
  }) : super(key: key);

  @override
  State<AdvancedOptionsStrip> createState() => _AdvancedOptionsStripState();
}

class _AdvancedOptionsStripState extends State<AdvancedOptionsStrip> {
  bool _loading = true;
  String _title = '';
  List<AdvancedOptionItem> _items = [];

  late final AdvancedOptionsService _svc;

  // âœ… Ù†Ø³Ø¨Ø© Ø§Ù„ØªØµØºÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„Ø© (30% Ù…Ù† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ)
  static const double _scaleFactor = 0.3;

  @override
  void initState() {
    super.initState();
    _svc = AdvancedOptionsService.fromServices();
    _fetchAdvancedList();
  }

  Future<void> _fetchAdvancedList() async {
    final pid = widget.product?.id;
    if (pid == null || (pid is String && pid.isEmpty)) {
      setState(() {
        _loading = false;
        _items = const [];
      });
      return;
    }

    try {
      final label = await _svc.fetchLabel(productId: pid as String);
      K.printLog('[AdvancedOptions] productId=$pid label=$label');

      final items = await _svc.fetchOptions(
        productId: pid,
        namespace: 'theme',
        key: 'advance_pr_type',
        first: 20,
      );
      K.printLog('[AdvancedOptions] fetched items count=${items.length}');

      setState(() {
        _title = (label != null && label.trim().isNotEmpty)
            ? label.trim()
            : widget.defaultLabel;
        _items = items;
        _loading = false;
      });
    } catch (e) {
      K.printLog('[AdvancedOptions] error=$e');
      setState(() {
        _title = widget.defaultLabel;
        _items = [];
        _loading = false;
      });
    }
  }

  /// ÙŠØ¬Ù„Ø¨ Ù…Ù†ØªØ¬ ÙƒØ§Ù…Ù„ Ù…Ù† Shopify Ø¹Ø¨Ø± Ø§Ù„Ù€ GID ÙˆÙŠØ¨Ù†ÙŠ ÙƒØ§Ø¦Ù† Product Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¹Ø±Ø¶
  Future<Product?> _fetchFullProduct(String gid) async {
    try {
      final client = _svc.client; // Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ø§ÙŠÙ†Øª Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©
      final q = gql(r'''
        query($id: ID!) {
          product(id: $id) {
            id
            title
            handle
            featuredImage { url }
            images(first: 20) { nodes { url } }
            priceRange {
              minVariantPrice { amount currencyCode }
              maxVariantPrice { amount currencyCode }
            }
            variants(first: 50) {
              nodes {
                availableForSale
                price { amount currencyCode }
                compareAtPrice { amount currencyCode }
              }
            }
          }
        }
      ''');

      final res = await client.query(QueryOptions(
        document: q,
        variables: {'id': gid},
        fetchPolicy: FetchPolicy.networkOnly,
      ));

      if (res.hasException) {
        K.printLog('[AdvancedOptions] fetchFullProduct error=${res.exception}');
        return null;
      }

      final data = res.data?['product'];
      if (data == null) return null;

      final imagesList = <String>[];
      final imgNodes = (data['images']?['nodes'] as List?) ?? const [];
      for (final n in imgNodes) {
        final u = n?['url'] as String?;
        if (u != null && u.isNotEmpty) imagesList.add(u);
      }
      final featured = (data['featuredImage']?['url'] as String?) ??
          (imagesList.isNotEmpty ? imagesList.first : null);

      // Ø£Ù‚Ù„ Ø³Ø¹Ø± + Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± + Ø³Ø¹Ø± Ø§Ù„Ø®ØµÙ… Ø¥Ù† ÙˆØ¬Ø¯
      String? priceStr;
      String? saleStr;
      bool inStock = false;

      final minRange = data['priceRange']?['minVariantPrice']?['amount'] as String?;
      if (minRange != null) {
        priceStr = minRange;
      }

      final vnodes = (data['variants']?['nodes'] as List?) ?? const [];
      for (final v in vnodes) {
        final avail = (v['availableForSale'] as bool?) ?? false;
        if (avail) inStock = true;

        final p = v['price']?['amount'] as String?;
        final cp = v['compareAtPrice']?['amount'] as String?;

        if (p != null && (priceStr == null || (double.tryParse(p) ?? 1e18) < (double.tryParse(priceStr) ?? 1e18))) {
          priceStr = p;
        }
        if (p != null && cp != null) {
          final dp = double.tryParse(p);
          final dcp = double.tryParse(cp);
          if (dp != null && dcp != null && dcp > dp) {
            saleStr = p; // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®ØµÙ…
          }
        }
      }

      final p = Product();
      p.id = data['id'] as String? ?? gid;
      p.name = (data['title'] as String?) ?? '';
      p.imageFeature = featured;
      p.images = imagesList;
      p.price = priceStr;

      try {
        // Ø¨Ø¹Ø¶ Ù†Ù…Ø§Ø°Ø¬ Product Ù‚Ø¯ ØªØ¯Ø¹Ù… inStock
        // ignore: invalid_use_of_internal_member
        // @dart=2.19 Ù„Ø§ Ù…Ø´ÙƒÙ„Ø© Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø­Ù‚Ù„
        // (Ø³ÙŠØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨ØµÙ…Øª Ø¹Ø¨Ø± dynamic)
        // p.regularPrice = saleStr != null ? priceStr : null;
        // p.salePrice     = saleStr;
        // p.inStock       = inStock;
      } catch (_) {}

      return p;
    } catch (e) {
      K.printLog('[AdvancedOptions] _fetchFullProduct exception=$e');
      return null;
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_loading) return const SizedBox.shrink();
    if (_items.isEmpty) return const SizedBox.shrink();

    // ğŸ”¹ ÙƒØ´Ù Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ù†ØµÙˆØµ Ù„Ù…Ù„Ù Ø§Ù„ØªØ±Ø¬Ù…Ø©
    final locale = Localizations.localeOf(context).languageCode;
    final isArabic = locale == 'ar';

    // ğŸ”¹ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹: Ø¥Ù† Ù„Ù… ÙŠØ£ØªÙ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ù†ÙˆÙ„Ù‘Ø¯Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    final titleText = _title.isNotEmpty
        ? _title
        : (isArabic ? 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ø®Ø±Ù‰' : 'More Options');

    // âœ… ØªØµØºÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© (ÙˆÙ„ÙŠØ³ Ù…Ø¬Ø±Ø¯ Transform Ø¨ØµØ±ÙŠ)
    final s = _scaleFactor; // 0.3 = 30%
    final cardWidth = widget.cardWidth * s;
    final imageSize = widget.cardImageSize * s;
    final itemSpacing = 8.0 * s;
    final outerPad = EdgeInsetsDirectional.fromSTEB(12 * s, 0, 12 * s, 0);
    final cardPad = EdgeInsets.all(10 * s);
    final radius = BorderRadius.circular(16 * s);
    final imgRadius = BorderRadius.circular(12 * s);
    final stripHeight = imageSize + (58 * s);

    // Ø£Ø­Ø¬Ø§Ù… Ø®Ø· Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø¹ Ø§Ù„ØªØµØºÙŠØ± â€” Ø§Ù„Ù†Øµ Ø£Ø³Ø§Ø³ÙŠÙ‹Ø§ ÙƒÙ„Ù…ØªÙŠÙ† ÙÙ‚Ø·
    final titleFontSize =
        (Theme.of(context).textTheme.titleMedium?.fontSize ?? 18) * 0.85;
    final labelFontSize =
        (Theme.of(context).textTheme.bodyMedium?.fontSize ?? 14) * 0.9;

    return Directionality(
      textDirection: isArabic ? TextDirection.rtl : TextDirection.ltr,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Padding(
            padding:
                EdgeInsetsDirectional.fromSTEB(16 * s, 12 * s, 16 * s, 8 * s),
            child: Text(
              titleText,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.w600,
                    fontSize: titleFontSize,
                  ),
            ),
          ),
          SizedBox(
            height: stripHeight,
            child: ListView.separated(
              padding: outerPad,
              scrollDirection: Axis.horizontal,
              itemCount: _items.length,
              separatorBuilder: (_, __) => SizedBox(width: itemSpacing),
              itemBuilder: (context, index) {
                final it = _items[index];

                return InkWell(
                  onTap: () async {
                    // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
                    final full = await _fetchFullProduct(it.id);
                    if (full == null) {
                      // fallback: Ø§ÙØªØ­ Ø¨Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø¨Ø³Ù‘Ø·
                      final fallback = Product()
                        ..id = it.id
                        ..name = it.title
                        ..imageFeature = it.imageUrl;
                      FluxNavigate.pushNamed(
                        K.RouteList.productDetail,
                        arguments: fallback,
                        context: context,
                      );
                      return;
                    }
                    FluxNavigate.pushNamed(
                      K.RouteList.productDetail,
                      arguments: full,
                      context: context,
                    );
                  },
                  borderRadius: radius,
                  child: Container(
                    width: cardWidth,
                    padding: cardPad,
                    decoration: BoxDecoration(
                      borderRadius: radius,
                      color: Theme.of(context).cardColor,
                      boxShadow: [
                        BoxShadow(
                          blurRadius: 8 * s,
                          color: Colors.black.withOpacity(0.05),
                          offset: Offset(0, 2 * s),
                        ),
                      ],
                    ),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.start,
                      children: [
                        ClipRRect(
                          borderRadius: imgRadius,
                          child: SizedBox(
                            width: imageSize,
                            height: imageSize,
                            child: (it.imageUrl != null && it.imageUrl!.isNotEmpty)
                                ? CachedNetworkImage(
                                    imageUrl: it.imageUrl!,
                                    fit: BoxFit.cover,
                                  )
                                : Image.asset(
                                    'assets/images/no_product_image.png',
                                    fit: BoxFit.cover,
                                  ),
                          ),
                        ),
                        SizedBox(height: 8 * s),
                        Text(
                          it.label, // Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø®ØªØµØ± ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø©
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                          textAlign: TextAlign.center,
                          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                                fontWeight: FontWeight.w500,
                                fontSize: labelFontSize,
                              ),
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}
